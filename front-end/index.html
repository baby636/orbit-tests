<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Blasting Off With Bootstrap</title>

  <link href="css/bootstrap.min.css" media="all" rel="stylesheet" />
  <link href="css/main.css" media="all" rel="stylesheet" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body>

<header class='navbar navbar-default navbar-fixed-top'>
  <nav class='container' role='navigation'>
    <div class='navbar-header'>
      <a href='index.html' class='navbar-brand'>Blasting Off With Bootstrap</a>

      <button type='button' class='navbar-toggle collapsed' data-toggle='collapse' data-target='.navbar-collapse'>
        <span class='sr-only'>Toggle navigation</span>
        <span class='icon-bar'></span>
        <span class='icon-bar'></span>
        <span class='icon-bar'></span>
      </button>
    </div>

    <ul class='nav navbar-nav navbar-right collapse navbar-collapse'>
      <li><a href='#'>Tickets</a></li>
      <li><a href='#'>Stations</a></li>
      <li class='dropdown'>
        <a href='/about' data-target='#' class='dropdown-toggle' data-toggle='dropdown'>About <span class='caret'></span></a>
        <ul class='dropdown-menu' role='menu'>
          <li><a href='#'>Our Story</a></li>
          <li><a href='#'>Contact Us</a></li>
          <li class='divider'></li>
          <li><a href='#'>Blog</a></li>
          <li class='divider'></li>
          <li><a href='#'>Twitter</a></li>
          <li><a href='#'>Facebook</a></li>
        </ul>
      </li>
    </ul>
  </nav>
</header>

<section style="padding-top: 70px;">
  <div class='container'>
    <div class='row well well-lg'>
      <div class='col-md-6'>
        <h2>The Fastest Way to Space</h2>
        <p class='lead'>Make your way to space in our rocket, elevator or transporter.</p>
        <button type='button' class='btn btn-lg btn-default'>Take the Tour</button>
        <button type='button' class='btn btn-lg btn-primary'>Book Tickets Now</button>
      </div>
      <div class='col-md-6 visible-md visible-lg'>
        <img src='images/img-header.jpg' alt='Blast off with Bootstrap' />
      </div>
    </div>

    <div class='row text-center features'>
      <div class='col-sm-4 col-xs-10 col-xs-offset-1 col-sm-offset-0'>
        <i class='glyphicon glyphicon-briefcase '></i>
        <h3>Book Today!</h3>
        <p>Even if you're traveling tomorrow, you can still get tickets today. We have a number of conveniently located ports around the globe to service everyone.</p>
      </div>

      <div class='col-sm-4 col-xs-6'>
        <i class='glyphicon glyphicon-random'></i>
        <h3>Go Anywhere</h3>
        <p>If you need to get to space today, why not try out a transporter? Despite the claims, there are have been no deaths in the last 6 weeks!</p>
      </div>

      <div class='col-sm-4 col-xs-6'>
        <i class='glyphicon glyphicon-send'></i>
        <h3>RocketBus&reg;</h3>
        <p>For cheapest fares, catch the next RocketBus&reg; to the stars. Cheaper on your wallet, and easiest way to make friends.</p>
      </div>
    </div>
  </div>
</section>

<section>
  <h2>Test Area</h2>

  <div class="container">
    <div class="row">
      <div class="col-sm-12">
        <canvas id="chart1"></canvas>
      </div>
    </div>
  </div>

  <hr>

  <div class="container">
    <div class="row">
      <div class="col-sm-12">
        <form class="form-inline">
          <div class="form-group">
            <label for="peerId">Handle </label>
            <input type="text" class="form-control" id="peerId" value="handle">
            <button type="button" class="btn btn-default" onclick="loadMyOrders()">Load Existing Orders</button>
          </div>
        </form>
      </div>
    </div>

    <div class="row">
      <div class="col-sm-12">
        <form class="form-inline">
          <div class="form-group">
            <label for="orderType">Type</label>
            <select id="orderType">
              <option value="buy">Buy</option>
              <option value="sell">Sell</option>
            </select>
          </div>

          <div class="form-group">
            <label for="price">Price</label>
            <input type="text" class="form-control" id="price" placeholder="1023">
          </div>

          <div class="form-group">
            <label for="qty">Qty</label>
            <input type="email" class="form-control" id="qty" placeholder="123">
          </div>

          <button type="button" class="btn btn-default" onclick="addOrder()">Add Order</button>
        </form>
      </div>
    </div>
  </div>

  <hr>

  <div class="container">
    <div class="row">
      <div class="col-sm-12">
        <h4>Open Orders</h4>
        <table class="table table-striped" id="orderTable">
          <tr id="trHeader">
            <th>Peer</th>
            <th>Order</th>
            <th>Price</th>
            <th>Qty</th>
            <th>Cancel</th>
          </tr>
          <tr id="trScaffold">
            <td class="tdPeer"></td>
            <td class="tdOrder"></td>
            <td class="tdPrice"></td>
            <td class="tdQty"></td>
            <td class="tdCancel"><button type="button" class="btn btn-default" style="display: none;">Cancel</button></td>
          </tr>
        </table>
      </div>
    </div>
  </div>

</section>



<!-- CDN -->
<!--
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
<script src="https://unpkg.com/ipfs/dist/index.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
-->

<!-- Local front-end Libraries -->
<script src="js/jquery.min.js"></script>
<script src="js/moment.min.js"></script>
<script src="js/index.min.js"></script>
<script src="js/Chart.min.js"></script>
<script src="js/orbitdb.min.js"></script>
<script src="js/bootstrap.min.js?body=1"></script>

<!-- Order book libraries -->
<script src="js/orderbook/orderbook.js"></script>

<script>

  const SERVER = `http://192.168.43.202:6543`;
  const PRICE_URL = '/price';
  const DB_URL = '/orderbook';

  // Chart variables.
  const prices = [1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000,];
  const labels = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20];
  let cfg;
  let ctx;
  let chart;

  // Database variables.
  let db;
  let dbReady = false; // Flag to signal when DB is ready to use.

  // Order book variables.
  let peers; // DB entry of other peers.


  // This function executes when the page has finished loading.
  $(document).ready(function() {

    // Initialize the price chart.
    ctx = document.getElementById('chart1').getContext('2d');
    ctx.canvas.width = 1000;
		ctx.canvas.height = 300;
    cfg = configChart();
		chart = new Chart(ctx, cfg);

    // Load IPFS and the Orbit DB.
    loadIPFS();
  });

  async function loadIPFS() {
    try {
      const dbAddress = await getDbAddress();
      console.log(`dbAddress: ${dbAddress}`);

      // Create IPFS instance
      const ipfs = new Ipfs({
        //repo: '/orbitdb/examples/browser/new/ipfs/0.27.3',
        repo: 'ipfs-' + Math.random(),
        start: true,
        EXPERIMENTAL: {
          pubsub: true,
        },
        config: {
          Addresses: {
            Swarm: [
              // Use IPFS dev signal server
              // '/dns4/star-signal.cloud.ipfs.team/wss/p2p-webrtc-star',
              '/dns4/ws-star.discovery.libp2p.io/tcp/443/wss/p2p-websocket-star',
              // Use local signal server
              // '/ip4/0.0.0.0/tcp/9090/wss/p2p-webrtc-star',
              '/ip4/192.168.43.202/tcp/4002/ipfs/QmW3hpPj61QqAFw1EP9WUQ3wMobpbGzwVaPxUr1tf4EviU'
            ]
          },
        }
      })

      ipfs.on('error', (e) => handleError(e))

      ipfs.on('ready', async () => {
        orbitdb = new OrbitDB(ipfs);
        db = await orbitdb.open(dbAddress, {
          // If database doesn't exist, create it
          create: true,
          overwrite: true,
          // Load only the local version of the database,
          // don't load the latest from the network yet
          localOnly: false,
          type: 'keyvalue',
          write: ['*'],
        });
        console.log(`Connected to DB ${dbAddress}`);

        db.events.on('ready', () => {
          console.log(`db is ready!`)
        })

        await db.load();
        console.log(`DB loaded.`)

        // Signal that the DB is ready for use.
        dbReady = true;

        // Retrieve existing orders from the DB.
        showOrders();

        db.events.on('replicated', (address) => {
          console.log(`DB just replicated with peer ${address}. Re-processing orders...`);
          resetTable();
          showOrders();
        })
      })
    } catch(err) {
      console.error(`Error in loadIPFS: `, err);
    }
  }

  function handleError(e) {
    console.error(e.stack)
    statusElm.innerHTML = e.message
  }

  // Get the price from the price API server.
  function getPrice() {
    return new Promise(function(resolve, reject) {
      $.get(`${SERVER}${PRICE_URL}`, '', function(data) {
        return resolve(Math.round(Number(data)*100)/100);
      })
      .fail((jqxhr, textStatus, error) => {
        return reject(error);
      })
    });
  }

  // Update the price array. Keeps the length of the array fixed.
  async function updatePrice() {
    try {
      //debugger;

      const newPrice = await getPrice();

      // Manipulate the arrays to ensure there are always a fixed number of data points.
      prices.shift();
      prices.push(newPrice);
      chart.data.datasets[0].data.shift();
      chart.data.datasets[0].data.push(newPrice);

      // Update the chart.
      chart.update();

    } catch(err) {
      //console.error(`Error in updatePrice(): `, err);
    }
  }

  // Chart configuration settings.
  function configChart() {
    const cfg = {
			type: 'bar',
			data: {
				labels: labels,
				datasets: [{
					label: 'CHRT - Chart.js Corporation',
					data: prices,
					type: 'line',
					pointRadius: 0,
					fill: false,
					lineTension: 0,
					borderWidth: 2
				}]
			},
			options: {
				scales: {
					yAxes: [{
						scaleLabel: {
							display: true,
							labelString: 'Closing price ($)'
						}
					}]
				}
			}
		};

    return cfg;
  }

  // Update the price every 2 seconds.
  const timer = setInterval(function() {
    updatePrice();
  }, 2000);

  // Get the DB IPFS address
  function getDbAddress() {
    return new Promise(function(resolve, reject) {
      $.get(`${SERVER}${DB_URL}`, '', function(data) {
        return resolve(data);
      })
      .fail((jqxhr, textStatus, error) => {
        return reject(error);
      })
    });
  }

  async function loadMyOrders() {
    try {
      console.log(`loadMyOrder button clicked!`)

      const myHandle = $('#peerId').val();

      // Get the list of peers
      let peers = db.get('peers')

      // Exit if peer is not found.
      if(!peers) return;
      if(peers.indexOf(myHandle) < 0) return;

      let orders = db.get(myHandle);

      console.log(`My orders: ${JSON.stringify(orders,null,2)}`)

    } catch(err) {
      console.error(`Error in loadMyOrders(): `, err);
      throw err;
    }
  }

  async function addOrder() {
    try {
      console.log(`addOrder button clicked!`)

      const buysell = $('#orderType').val() === "buy";
      const price = $('#price').val();
      const qty = $('#qty').val();

      // Input Validation
      if(price === "") return;
      if(qty === "") return;

      // Retrieve data from the web forms.
      const myHandle = $('#peerId').val();
      const myOrder = {
        buysell: buysell,
        price: price,
        qty: qty
      }

      // Get the list of peers
      let peers = db.get('peers')

      // Handle a new DB.
      if(!peers) {
        peers = [myHandle]
        await db.put('peers', peers);

      // Add user to peers list if they aren't already there.
      } else {
        if(peers.indexOf(myHandle) === -1) {
          peers.push(myHandle);
          await db.put('peers', peers);
        }
      }


      // Get existing orders for this peer.
      let myOrders = db.get(myHandle);

      if(!myOrders) {
        myOrders = [myOrder];
      } else {
        myOrders.push(myOrder);
      }

      // Save the new order to the DB.
      await db.put(myHandle, myOrders);

      console.log(`Order added to DB!`)

    } catch(err) {
      console.error(`Error in addOrder(): `,err);
      throw err;
    }
  }

</script>
</body>
</html>
